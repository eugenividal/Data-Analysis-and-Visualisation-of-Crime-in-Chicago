---
title: "Chicago Crime: Data Analysis and \n Visualisations using R"
author: 'Student ID: 201081646'
date: "November 3, 2018"
output:
  pdf_document:
    fig_caption: yes
    fig_crop: yes
    fig_height: 4
    fig_width: 6
    keep_tex: yes
    number_sections: yes
    toc_depth: 2
  html_document:
    fig_caption: yes
    theme: journal
    toc: yes
    toc_depth: 2
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}
---
```{r, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
# load libraries
library(ggplot2)
library(ggmap)
library(lubridate)
library(scales)
library(zoo)
library(dplyr)
library(knitr)
```

# Introduction

This report is the first assessment for the **MATH5741M Statistical Theory and Methods** module. Its objective is to summarise statistically a dataset sample of crimes in the city of Chicago and answer the following research questions:

- How crime has changed in the city of Chicago over the years? 

- What time of day do most types of crime occur?

- In which locations are specific types of crime more likely to happen?

- Which districts of the city are potentially more dangerous per type of crime?

# Data and methods

The dataset analysed is a sample of the [original data of crimes extracted from the Chicago Police Department](https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2) which content the crimes that occurred in the city of Chicago from 2001 to present.

For the analysis, first, we prepare the data creating, transforming and simplifying variables, as well as cleaning the dataset keeping the variables we are interested in. Secondly, we make a basic univariable analysis of the dataset, and then, with a multianalysys based on heatmaps we answer our research questions. Finally, we sumarise the findings.

This report has been done with `Rmarkdown`, although due to space limitations only the `R` code cells that have been considered most significant are shown. To see the complete code see  https://github.com/eugenividal/Chicago-Crime-Data-Analysis.

# Results

## Data preparation

First, we load the data into the `R` environment.

```{r eval=TRUE, echo=TRUE}
# Read csv in R
dd=read.csv("http://www1.maths.leeds.ac.uk/~charles/math5741/crime.csv",header=T)
```

Second, we create the new variables (`Count`, `Month_year`, `Hour`) based on the existing ones, and give them the right format for later explotation. 

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Create a variable count with value 1
dd$Count <- 1
# Extract hour from Date
dd$Hour <- substring(dd$Date, 12,13)
# Drop time from Date
dd$Date <- as.Date(dd$Date, format="%m/%d/%Y")
# Drop days from Date
dd$Month_year <- as.Date(as.yearmon(dd$Date, "%Y-%m"))
# Change format of variables
dd$Hour <- as.factor(dd$Hour)
dd$Primary.Type <- as.factor(dd$Primary.Type)
dd$Location.Description <- as.factor(dd$Location.Description)
dd$District<- as.factor(dd$District)
```

Third, we simplify the variables `Primary.Type` and `Location.Description` grouping their categories and call them `Type_grouped` and `Location_grouped` respectivelly <sup></sup>^[This code is not showed here due to space limitations].

```{r, include=FALSE}
# Group Primary.Type categories
dd$Type_grouped[dd$Primary.Type == "THEFT" | dd$Primary.Type == "MOTOR VEHICLE THEFT" ] <- "Theft"

dd$Type_grouped[dd$Primary.Type == "BATTERY"] <- "Batery"

dd$Type_grouped[dd$Primary.Type == "CRIMINAL DAMAGE"] <- "Criminal damage"

dd$Type_grouped[dd$Primary.Type == "NARCOTICS" | dd$Primary.Type == "OTHER NARCOTIC VIOLATION"] <- "Narcotics"

dd$Type_grouped[dd$Primary.Type == "OTHER OFFENSE"] <- "Other offense"

dd$Type_grouped[dd$Primary.Type == "ASSAULT"] <- "Assault"

dd$Type_grouped[dd$Primary.Type == "BURGLARY"] <- "Burglary"

dd$Type_grouped[dd$Primary.Type == "ROBBERY" ] <- "Robery"

dd$Type_grouped[dd$Primary.Type == "DECEPTIVE PRACTICE"] <- "Deceptive practice"

dd$Type_grouped[dd$Primary.Type == "ARSON" | dd$Primary.Type == "CONCEALED CARRY LICENSE VIOLATION" | dd$Primary.Type == "CRIMINAL TRESPASS" | dd$Primary.Type == "GAMBLINGS" | dd$Primary.Type == "HUMAN TRAFFICKING" | dd$Primary.Type == "INTERFERENCE WITH PUBLIC OFFICER" | dd$Primary.Type == "INTIMIDATION" | dd$Type == "KIDNAPPING" | dd$Type == "LIQUOR LAW VIOLATION" | dd$Primary.Type == "NON-CRIMINAL" | dd$Primary.Type == "NON - CRIMINAL" | dd$Primary.Type == "OBSCENITY" | dd$Primary.Type == "OFFENSE INVOLVING CHILDREN"| dd$Primary.Type == "PROSTITUTION"| dd$Primary.Type == "PUBLIC INDECENCY"| dd$Primary.Type == "PUBLIC PEACE VIOLATION"| dd$Primary.Type == "STALKING"| dd$Primary.Type == "WEAPONS VIOLATION"| dd$Primary.Type == "HOMICIDE"| dd$Primary.Type == "CRIM SEXUAL ASSAULT" | dd$Primary.Type == "SEX OFFENSE"] <- "Others"
```

```{r, include=FALSE}
# Group Location.Description categories
dd$Location_grouped[dd$Location.Description == "\"SCHOOL- PRIVATE- BUILDING\"" | dd$Location.Description ==  "\"SCHOOL- PRIVATE- GROUNDS\"" | dd$Location.Description == "\"SCHOOL- PUBLIC- BUILDING\"" | dd$Location.Description == "\"SCHOOL- PUBLIC- GROUNDS\"" | dd$Location.Description == "COLLEGE/UNIVERSITY GROUNDS" | dd$Location.Description == "COLLEGE/UNIVERSITY RESIDENCE HALL"| dd$Location.Description == "SCHOOL YARD"]<- "School/university"

dd$Location_grouped[dd$Location.Description == "" | dd$Location.Description == "ABANDONED BUILDING"| dd$Location.Description == "AIRCRAFT" | dd$Location.Description == "ANIMAL HOSPITAL" | dd$Location.Description == "ATHLETIC CLUB" | dd$Location.Description == "AUTO" | dd$Location.Description == "BASEMENT"  | dd$Location.Description == "BOAT/WATERCRAFT" | dd$Location.Description == "CHA GROUNDS" | dd$Location.Description == "CHA HALLWAY"  | dd$Location.Description == "CHA HALLWAY/STAIRWELL/ELEVATOR" | dd$Location.Description == "CHURCH" | dd$Location.Description == "CHURCH/SYNAGOGUE/PLACE OF WORSHIP"| dd$Location.Description == "COIN OPERATED MACHINE"| dd$Location.Description == "CONSTRUCTION SITE"| dd$Location.Description == "OTHER"| dd$Location.Description == "CHURCH"| dd$Location.Description == "OTHER RAILROAD PROP / TRAIN DEPOT" | dd$Location.Description =="SEWER" | dd$Location.Description =="STAIRWELL"| dd$Location.Description == "VACANT LOT" | dd$Location.Description =="VACANT LOT/LAND"| dd$Location.Description == "VESTIBULE" | dd$Location.Description =="WOODED AREA" | dd$Location.Description == "CTA STATION" | dd$Location.Description == "CTA BUS STOP"| dd$Location.Description == "CTA TRACKS - RIGHT OF WAY"  | dd$Location.Description == "AIRPORT BUILDING NON-TERMINAL - NON-SECURE AREA" | dd$Location.Description == "AIRPORT BUILDING NON-TERMINAL - SECURE AREA" | dd$Location.Description == "AIRPORT EXTERIOR - NON-SECURE AREA" | dd$Location.Description == "AIRPORT EXTERIOR - SECURE AREA" | dd$Location.Description == "AIRPORT PARKING LOT" | dd$Location.Description ==  "AIRPORT TERMINAL LOWER LEVEL - NON-SECURE AREA" | dd$Location.Description == "AIRPORT TERMINAL LOWER LEVEL - SECURE AREA" | dd$Location.Description == "AIRPORT TERMINAL MEZZANINE - NON-SECURE AREA"| dd$Location.Description == "AIRPORT TERMINAL UPPER LEVEL - NON-SECURE AREA"| dd$Location.Description == "AIRPORT TERMINAL UPPER LEVEL - SECURE AREA"| dd$Location.Description == "AIRPORT TRANSPORTATION SYSTEM (ATS)"| dd$Location.Description == "AIRPORT VENDING ESTABLISHMENT" | dd$Location.Description == "AIRPORT/AIRCRAFT" |dd$Location.Description == "DAY CARE CENTER"| dd$Location.Description == "COMMERCIAL / BUSINESS OFFICE"| dd$Location.Description == "FACTORY" | dd$Location.Description =="FACTORY/MANUFACTURING BUILDING" | dd$Location.Description =="FEDERAL BUILDING"| dd$Location.Description == "FIRE STATION"| dd$Location.Description == "GOVERNMENT BUILDING/PROPERTY"| dd$Location.Description == "HOSPITAL"| dd$Location.Description == "HOSPITAL BUILDING/GROUNDS"| dd$Location.Description == "JAIL / LOCK-UP FACILITY"| dd$Location.Description == "LIBRARY"| dd$Location.Description == "MOVIE HOUSE/THEATER"  | dd$Location.Description =="NURSING HOME/RETIREMENT HOME"| dd$Location.Description == "POOL ROOM" | dd$Location.Description =="SPORTS ARENA/STADIUM"| dd$Location.Description == "WAREHOUSE" | dd$Location.Description == "BANK"| dd$Location.Description == "CREDIT UNION"| dd$Location.Description == "CURRENCY EXCHANGE"| dd$Location.Description == "SAVINGS AND LOAN"]<- "Others"

dd$Location_grouped[dd$Location.Description == "ALLEY" | dd$Location.Description == "BOWLING ALLEY" | dd$Location.Description == "CHA BREEZEWAY" | dd$Location.Description =="HALLWAY"]<- "Alley" 

dd$Location_grouped[dd$Location.Description == "APARTMENT"| dd$Location.Description == "CHA APARTMENT"]<- "Apartment"

dd$Location_grouped[dd$Location.Description == "APPLIANCE STORE" | dd$Location.Description == "BARBERSHOP" | dd$Location.Description == "CAR WASH" | dd$Location.Description == "CLEANING STORE" | dd$Location.Description ==  "CONVENIENCE STORE" | dd$Location.Description =="DEPARTMENT STORE" | dd$Location.Description =="DRUG STORE"| dd$Location.Description == "GARAGE/AUTO REPAIR"| dd$Location.Description == "GAS STATION"| dd$Location.Description == "GAS STATION DRIVE/PROP." | dd$Location.Description =="GROCERY FOOD STORE"| dd$Location.Description == "MEDICAL/DENTAL OFFICE" | dd$Location.Description =="NEWSSTAND"| dd$Location.Description == "OFFICE"| dd$Location.Description == "PAWN SHOP" | dd$Location.Description =="RETAIL STORE"| dd$Location.Description == "SMALL RETAIL STORE"]<- "Store/small business"

dd$Location_grouped[dd$Location.Description == "ATM (AUTOMATIC TELLER MACHINE)" | dd$Location.Description == "BRIDGE"| dd$Location.Description == "DRIVEWAY"| dd$Location.Description == "GANGWAY"| dd$Location.Description == "HIGHWAY/EXPRESSWAY"| dd$Location.Description == "LAKEFRONT/WATERFRONT/RIVERBANK"| dd$Location.Description == "SIDEWALK" | dd$Location.Description == "STREET"]<- "Street"

dd$Location_grouped[dd$Location.Description == "BAR OR TAVERN"| dd$Location.Description == "HOTEL"| dd$Location.Description == "HOTEL/MOTEL"| dd$Location.Description == "RESTAURANT"| dd$Location.Description == "TAVERN"| dd$Location.Description == "TAVERN/LIQUOR STORE"]<- "Restaurant/bar/hotel"

dd$Location_grouped[dd$Location.Description == "CHA PARKING LOT" | dd$Location.Description =="PARK PROPERTY" | dd$Location.Description =="PARKING LOT"| dd$Location.Description == "PARKING LOT/GARAGE(NON.RESID.)" | dd$Location.Description =="POLICE FACILITY/VEH PARKING LOT"]<- "Parking lot"

dd$Location_grouped[dd$Location.Description == "TRAILER" | dd$Location.Description == "TRUCK" | dd$Location.Description == "VEHICLE - DELIVERY TRUCK"| dd$Location.Description ==  "VEHICLE - OTHER RIDE SERVICE"| dd$Location.Description ==  "VEHICLE NON-COMMERCIAL" | dd$Location.Description == "VEHICLE-COMMERCIAL" | dd$Location.Description == "CTA BUS" | dd$Location.Description =="DELIVERY TRUCK" | dd$Location.Description =="TAXICAB" | dd$Location.Description == "CTA TRAIN" | dd$Location.Description == "OTHER COMMERCIAL TRANSPORTATION"]<- "Vehicle" 

dd$Location_grouped[dd$Location.Description == "CTA GARAGE / OTHER PROPERTY" | dd$Location.Description =="DRIVEWAY - RESIDENTIAL" | dd$Location.Description =="GARAGE" | dd$Location.Description =="HOUSE" | dd$Location.Description == "PORCH" | dd$Location.Description =="RESIDENCE" | dd$Location.Description == "RESIDENCE PORCH/HALLWAY"| dd$Location.Description == "RESIDENCE-GARAGE"| dd$Location.Description == "RESIDENTIAL YARD (FRONT/BACK)"| dd$Location.Description == "YARD"]<- "Residence"
```

Next, we drop all variables we do not need to perform the general anasylis or answer our research questions.

```{r, echo=TRUE}
# Drop all variables we are not interested in
dd <- dd[, -c(1:2, 4:11, 13:18)]
```

Then, we clean the dataset of missing values.

```{r, echo=TRUE}
# Remove NAs
dd <- dd[complete.cases(dd),]
```

Finally, the dataset is ready for the explotation.

```{r, echo=TRUE}
# Show first 5 records
head(dd)
```

## Data exploration

### How crime has changed in the city of Chicago over the years? 

Figure 1<sup></sup>^[The code to create the graphs is not showed here either] shows the evolution by month of the crimes from 2001 to the present. There is an obvious periodic pattern and a clear downward trend.

```{r fig, fig.cap="Crimes evolution", echo=FALSE, message=FALSE, warning=FALSE}
# Plot the graph 
ggplot(dd, aes(x=Month_year))+geom_line(color='steelblue', stat="Count") + theme_minimal() + theme(axis.title.x=element_blank()) + theme(axis.title.y=element_blank()) 
```

Except for the deceptive practice, all the crimes have decresead in more or less grade. 

```{r, include=FALSE}
# create the function multiplot
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  require(grid)
  # make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  numPlots = length(plots)
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }
 if (numPlots==1) {
    print(plots[[1]])
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

```{r, fig2, fig.cap="Evolution per type of crime", echo=FALSE, message=FALSE, warning=FALSE, out.extra='',fig.align='center'}
# Create a graph with each type evolution

p1 <- ggplot(subset(dd, Type_grouped == "Theft"), aes(x=Month_year))+geom_line(color='steelblue', stat="Count")+
labs(y = "Theft") + theme_minimal() + theme(axis.title.x=element_blank()) + theme(text = element_text(size=8))

p2 <- ggplot(subset(dd, Type_grouped == "Batery"), aes(x=Month_year))+geom_line(color='steelblue',stat="Count")+
labs(y = "Batery") + theme_minimal() + theme(axis.title.x=element_blank())  + theme(text = element_text(size=8))

p3 <- ggplot(subset(dd, Type_grouped == "Criminal damage"), aes(x=Month_year))+geom_line(color='steelblue', stat="Count")+
labs(y = "Criminal\n damage") + theme_minimal() + theme(axis.title.x=element_blank())  + theme(text = element_text(size=8))

p4 <- ggplot(subset(dd, Type_grouped == "Narcotics"), aes(x=Month_year))+geom_line(color='steelblue', stat="Count")+
labs(y = "Narcotics") + theme_minimal() + theme(axis.title.x=element_blank())  + theme(text = element_text(size=8))

p5 <- ggplot(subset(dd, Type_grouped == "Others"), aes(x=Month_year))+geom_line(color='steelblue', stat="Count")+
labs(y = "Others") + theme_minimal() + theme(axis.title.x=element_blank())  + theme(text = element_text(size=8))

p6 <- ggplot(subset(dd, Type_grouped == "Other offense"), aes(x=Month_year))+geom_line(color='steelblue', stat="Count")+
labs(y = "Other\n offense") + theme_minimal() + theme(axis.title.x=element_blank())  + theme(text = element_text(size=8))

p7 <- ggplot(subset(dd, Type_grouped == "Assault"),  aes(x=Month_year))+geom_line(color='steelblue', stat="count") +
labs(y = "Assault") + theme_minimal() + theme(axis.title.x=element_blank()) + theme(text = element_text(size=8))

p8 <- ggplot(subset(dd, Type_grouped == "Burglary"), aes(x=Month_year))+geom_line(color='steelblue', stat="Count")+
labs(y = "Burglary") + theme_minimal() + theme(axis.title.x=element_blank())  + theme(text = element_text(size=8))

p9 <- ggplot(subset(dd, Type_grouped == "Robery"), aes(x=Month_year))+geom_line(color='steelblue', stat="Count")+
labs(y = "Robery") + theme_minimal() + theme(axis.title.x=element_blank())  + theme(text = element_text(size=8))

p10 <- ggplot(subset(dd, Type_grouped == "Deceptive practice"), aes(x=Month_year))+geom_line(color='steelblue', stat="Count")+
labs(y = "Deceptive\n practice") + theme_minimal() + theme(axis.title.x=element_blank())  + theme(text = element_text(size=8))

multiplot(p1, p2, p3, p4, p5, p6, p7, p8, p9, p10, cols=2) 
```

### What time of day do most types of crime occur?

Are some types of crimes more likely to happen in specific time of the day?

The most dangerous hours per Thefth are 00 and 12.

```{r fig9, fig.cap="Type of crime vs hour", echo=FALSE, out.extra='', fig.align='center'}
# add variable: performance
count_h <- aggregate(Count ~ Type_grouped + Hour, data = dd, FUN = sum)
# Plot graph
p1 <- ggplot(data = count_h, aes(x = Hour, y = Type_grouped)) + geom_tile(aes(fill = Count), color = "white") +
  scale_fill_gradient(low = "white", high = "steelblue") 
p1 + theme_minimal()+ theme(axis.title.x=element_blank()) + theme(axis.title.y=element_blank()) +
  theme(legend.title = element_text(size = 10),
        legend.text = element_text(size = 6),
        axis.text.y = element_text(size= 8),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 
```

### In which locations are specific types of crime more likely to happen?

Are some types of crimes more likely to happen in specific locations?

Street is particularly important for Theft.

```{r fig11, fig.cap="Type of crime vs location", echo=FALSE, out.extra='',fig.align='center'}
# add variable: performance
count_l <- aggregate(Count ~  Type_grouped + Location_grouped, data = dd, FUN = sum)

p2 <- ggplot(data = count_l, aes(x = Location_grouped, y = Type_grouped)) + geom_tile(aes(fill = Count), color = "white") +
  scale_fill_gradient(low = "white", high = "steelblue") 
p2+ theme_minimal()+ theme(axis.title.x=element_blank()) + theme(axis.title.y=element_blank()) +
  theme(legend.title = element_text(size = 10),
        legend.text = element_text(size = 6),
        axis.text.y = element_text(size= 8),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 
```

### Which districts of the city are potentially more dangerous per type of crime?

Are some types of crimes more likely to happen in specific distrits?

Narcotics in district 11 is crealy a problem.

```{r fig10, fig.cap="Type of crime vs district", echo=FALSE, out.extra='',fig.align='center'}
# Remove values districts 21 and 31
dd_sub <- subset(dd, District!="21" & District!="31")
# add variable: performance
count_d <- aggregate(Count ~ Type_grouped + District, data = dd_sub, FUN = sum)

p3<-ggplot(data = count_d, aes(x = District, y = Type_grouped)) +
  geom_tile(aes(fill = Count), color = "white") +
  scale_fill_gradient(low = "white", high = "steelblue")  
p3+ theme_minimal()+ theme(axis.title.x=element_blank()) + theme(axis.title.y=element_blank()) +
  theme(legend.title = element_text(size = 10),
        legend.text = element_text(size = 6),
        axis.text.y = element_text(size= 8),
        axis.text.x = element_text(size = 8, angle = 45, hjust = 1)) 
```

# Conclusions


