---
title: 'Crime in Chicago: Data Analysis and Visualizations using R'
author: '201081646'
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

```{r}
# load libraries
library(ggplot2)
library(ggmap)
library(lubridate)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
```

# Introduction

This is the first assessment for the **Statistical Theory and Methods module**. 

# Objective

The objective is to: 

- Summarise a sample of dataset.

- Highlight key finding.

# Data and methods

The dataset we use is a random sample of 500,000 rows of the orginial data which come from https://data.cityofchicago.org/Public-Safety/Crimes-2001-to-present/ijzp-q8t2.

```{r eval=TRUE, include=FALSE}
# read csv in R
dd=read.csv("http://www1.maths.leeds.ac.uk/~charles/math5741/crime.csv",header=T)
```

# Results

## Data preparation

### Look at the data

First, we have a look at the data.

```{r}
names(dd)
```

### Data cleaning

We drop all the variables we are not interested.

Interesting and fesiable variables: 
- Date
- Type (need to aggregate data) 
- Arrest 
- Domestic 
- (beat, district, area or ward), 
- lat, lon.

```{r}
# Drop all variables we are not interested
dd <- dd[, -c(1:2, 4:5, 7, 11, 13:15)]
```

Altohugh depending on the study we could do with the missing data. here to make it easier we will drop the data which are NA.

```{r}
# Remove missing values
dd <- dd[complete.cases(dd),]
```

```{r}
# Clean variables
# dd <- dd[dd$Year >= 2006,]
```

#### Data transformation

```{r}
# Create a variable count with value 1
dd$count <- 1
# Convert starttime from factor to date
dd$Date <- mdy_hms(dd$Date)

# Extract hour from datetime value
dd$hour <- substring(dd$Date, 12,13)
# Convert hour from character to factor
dd$hour <- as.factor(dd$hour)

# Only date
dd$Date <- as.Date(dd$Date, format="%m/%d/%Y")

# Extract month - the mon component of a POSIXlt object is the numeric month (0-11 starting on January)
dd$mon <- as.POSIXlt(dd$Date)$mon
# Convert weekday from character to factor
dd$mon <- c("January", "February", "March", "April", "May", "June", "July", "Agust", "September", "October", "November", "Desember")[as.POSIXlt(dd$Date)$mon + 1]
# Convert month from character to factor
dd$mon <- as.factor(dd$mon)

# Extract weekdays - the wday component of a POSIXlt object is the numeric weekday (0-6 starting on Sunday)
dd$weekday <- as.POSIXlt(dd$Date)$wday
dd$weekday <- c("Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", 
    "Friday", "Saturday")[as.POSIXlt(dd$Date)$wday + 1]
# Convert weekday from character to factor
dd$weekday <- as.factor(dd$weekday)
```

```{r}
dd$Type_grouped[dd$Primary.Type == "THEFT" | dd$Primary.Type == "MOTOR VEHICLE THEFT" ] <- "Theft"
dd$Type_grouped[dd$Primary.Type == "BATTERY"] <- "Batery"
dd$Type_grouped[dd$Primary.Type == "CRIMINAL DAMAGE"] <- "Criminal damage"
dd$Type_grouped[dd$Primary.Type == "NARCOTICS" | dd$Primary.Type == "OTHER NARCOTIC VIOLATION"] <- "Narcotics"
dd$Type_grouped[dd$Primary.Type == "OTHER OFFENSE"] <- "Other offense"
dd$Type_grouped[dd$Primary.Type == "ASSAULT"] <- "Assault"
dd$Type_grouped[dd$Primary.Type == "BURGLARY"] <- "Burglary"
dd$Type_grouped[dd$Primary.Type == "ROBBERY" ] <- "Robery"
dd$Type_grouped[dd$Primary.Type == "DECEPTIVE PRACTICE"] <- "Deceptive practice"
dd$Type_grouped[dd$Primary.Type == "CRIM SEXUAL ASSAULT" | dd$Primary.Type == "SEX OFFENSE"] <- "Sexual crimes"
dd$Type_grouped[dd$Primary.Type == "HOMICIDE"] <- "Homicide"
dd$Type_grouped[dd$Primary.Type == "ARSON" | dd$Primary.Type == "CONCEALED CARRY LICENSE VIOLATION" | dd$Primary.Type == "CRIMINAL TRESPASS" | dd$Primary.Type == "GAMBLINGS" | dd$Primary.Type == "HUMAN TRAFFICKING" | dd$Primary.Type == "INTERFERENCE WITH PUBLIC OFFICER" | dd$Primary.Type == "INTIMIDATION" | dd$Type == "KIDNAPPING" | dd$Type == "LIQUOR LAW VIOLATION" | dd$Primary.Type == "NON-CRIMINAL" | dd$Primary.Type == "NON - CRIMINAL" | dd$Primary.Type == "OBSCENITY" | dd$Primary.Type == "OFFENSE INVOLVING CHILDREN"| dd$Primary.Type == "PROSTITUTION"| dd$Primary.Type == "PUBLIC INDECENCY"| dd$Primary.Type == "PUBLIC PEACE VIOLATION"| dd$Primary.Type == "STALKING"| dd$Primary.Type == "WEAPONS VIOLATION"] <- "Others"
```

```{r}
# convert all variables in factor
# dd$Type_grouped<- as.factor(dd$Type_grouped)
# dd$District<- as.factor(dd$District)
```

Do the same but with location. Order the 10 most important. Justify also the thing done before with this - The 10 most important.

```{r}
#install.packages('plyr')
#library(plyr)
#y = count(dd, 'Location.Description')
#plot(y)
```

```{r}
# create a list with most frequent locations
temp <- row.names(as.data.frame(summary(dd$Location.Description, max=20))) # create a df or something else with the summary output.
dd$Location.Description <- as.character(dd$Location.Description) # IMPORTANT! Here was the problem: turn into character values
# create new column that filters top results
dd$top <- ifelse(
        dd$Location.Description %in% temp,
        dd$Location.Description,
        "Other")
dd$top <- as.factor(dd$top) # factorize the output again
# plot
ggplot(dd,aes(x=
                  factor(top,
                         levels=names(sort(table(top),increasing=TRUE))
                  )
                )
                ) + geom_bar() + coord_flip()
```



```{r}
# aggregate the data
#aggr <- aggregate(count ~ Beat + District, data = dd, FUN = sum)
# plot boxplot.
#p1 <- ggplot(aggr, aes(x= District, y = count)) + geom_boxplot() 
#p1 
```

## Data exploration

This section explores the data visually to identify the key patterns.

### Graphs

Evolution of crime in Chicago per day/see just year

```{r}
# Plot the graph 
ggplot(data= dd, aes(x= Date, fill= Arrest)) + geom_line(stat="count") +
  xlab ("Date") + theme (axis.text.x = element_text(angle = 90, hjust = 2)) + scale_fill_discrete(name = "Arrest", labels=c("TRUE", "FALSE"))
```

```{r}
# Plot the graph 
ggplot(dd, aes(x=mon, fill= Arrest))+geom_bar(stat="count")+
  xlab("mon")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + labs(x = "Month", y = "Trip Count")+ scale_fill_discrete(name = "Arrest", labels=c("True", "False"))+ ggtitle("Number of crimes per month")

```

```{r}
# Plot the graph 
ggplot(dd, aes(x=hour, fill= Arrest))+geom_bar(stat="count")+
  xlab("mon")+ theme(axis.text.x = element_text(angle = 90, hjust = 1)) + labs(x = "Hour", y = "Trip Count") + scale_fill_discrete(name = "Arrest", labels=c("True", "False"))+ ggtitle("Number of crimes per month")
```

Evolution per type of crime. Small graphs different colours per crime.

```{r}
# Plot the graph 
ggplot(data= dd, aes(x= hour, fill= District)) + geom_bar(stat="count") +
  xlab ("Hour") + theme (axis.text.x = element_text(angle = 90, hjust = 2))
```

# Location and description 

```{r}
# Plot the graph 
levels(dd$type)
ggplot(data= dd, aes(x= District, fill= Arrest)) + geom_bar(stat="count") 
```

### records by time, type and location

### Temporal analysis of crime rates by type and location

Analysis of an speficic crime and map it.

### Maps

```{r warning=FALSE}
# Fetch Boundary Specified Map
lat <- c(42.0,41.7)
long <- c(-87.8, -87.5) 
bbox <- make_bbox(long,lat,f=0.05)
b <- get_map(bbox,maptype="toner-lite",source="stamen")
```

```{r}
pp <- dd[dd$Type_grouped == "Homicide",]
```

```{r}
ggmap(b) + geom_point(data = pp, 
           aes(lon,lat,color=Year),size=0.5,alpha=0.7) +
           labs(x = "Longitude", y = "Latitude",
           title="Homicides", color = "Year")
```



# Discussion

# Conclusions

# References
